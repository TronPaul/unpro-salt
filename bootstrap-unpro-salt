#!/bin/bash
_MINON_ID=""
_INSTALL_UNPRO_SALT=0

# Fix for AWS PATH
PATH="/usr/local/bin:$PATH"

while getopts ":i:" opt
do
  case "${opt}" in

    i )  _MINION_ID=$OPTARG ;;

    \?)  echo "Option does not exist : $OPTARG"
         exit 1
         ;;
  esac
done

if ! hash salt-call 2>/dev/null; then
  wget -q -O install_salt.sh https://raw.githubusercontent.com/saltstack/salt-bootstrap/stable/bootstrap-salt.sh
  if [ -n "$_MINION_ID" ]; then
    sh install_salt.sh -X -i $_MINION_ID -g https://github.com/TronPaul/salt.git git v2014.7.2
  else
    sh install_salt.sh -X -g https://github.com/TronPaul/salt.git git v2014.7.2
  fi
  _INSTALL_UNPRO_SALT=$?
else
  if [ "$_MINION_ID" != "null" ]; then
    echo $_MINION_ID > /etc/salt/minion_id
  fi
fi

sed -i "s/^#file_client: remote$/file_client: local/g" /etc/salt/minion
if [ $_INSTALL_UNPRO_SALT -eq 0 ]; then
  # Add github rsa key
  salt-call ssh.set_known_host hostname=github.com fingerprint='16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48' enc='ssh-rsa'
  # Get/Update unpro-salt
  if [ -d /srv/unpro-salt ]; then
    salt-call git.pull /srv/unpro-salt
  else
    salt-call git.clone /srv/unpro-salt https://github.com/TronPaul/unpro-salt.git opts='--depth 1 --recursive'
  fi
  if ! salt-call file.is_link /srv/salt; then
    ln -s /srv/unpro-salt/state /srv/salt
  fi
  if ! salt-call file.is_link /srv/formulas; then
    ln -s /srv/unpro-salt/formulas /srv/formulas
  fi
  if ! salt-call file.is_link /srv/pillar; then
    ln -s /srv/unpro-salt/pillar /srv/pillar
  fi
  if [ -f /etc/keys/teamunpro_deploy_id_rsa ]; then
    if [ -d /srv/unpro-pillar-secrets ]; then
      salt-call git.pull /srv/unpro-pillar-secrets identity=/etc/keys/teamunpro_deploy_id_rsa
    else
      salt-call git.clone /srv/unpro-pillar-secrets git@github.com:TronPaul/unpro-pillar-secrets.git opts='--depth 1' identity=/etc/keys/teamunpro_deploy_id_rsa
    fi
  fi
  if [ -d /srv/unpro-pillar-secrets ] && ! salt-call file.is_link /srv/pillar-secrets; then
    ln -s /srv/unpro-pillar-secrets /srv/pillar-secrets
  fi
  # Copy grain if found
  _MINION_ID=$(salt-call --out txt grains.get id | cut -d ' ' -f 2)
  _GRAIN_PATH="/srv/unpro-salt/salt/grains/$_MINION_ID"
  if [ -f $_GRAIN_PATH ]; then
    cp $_GRAIN_PATH /etc/salt/grains
  fi
  # Copy custom minion config
  if ! grep -q '######## unPRO salt minion config ########' /etc/salt/minion; then
    cp /srv/unpro-salt/salt/minion /etc/salt/minion
  fi
  salt-call state.highstate
fi
