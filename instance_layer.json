{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "unPRO stack",

  "Parameters" : {
    "KeyName" : {
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instances",
      "Type" : "String",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern" : "[-_ a-zA-Z0-9]*",
      "ConstraintDescription" : "can contain only alphanumeric characters, spaces, dashes and underscores."
    },
    "VPC" : {
      "Description" : "VpcId of the VPC to use",
      "Type" : "String"
    },
    "VpcCidr" : {
      "Description" : "Cidr of the Vpc",
      "Type" : "String"
    },
    "PrivateSubnet" : {
      "Description" : "PrivateSubnetId to use",
      "Type" : "String"
    },
    "MumbleNodeInstanceType" : {
      "Description" : "Instance type for Mumble nodes.",
      "Type" : "String",
      "Default" : "t2.micro",
      "AllowedValues" : [ "t2.micro","t2.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    },
    "VPNNodeInstanceType" : {
      "Description" : "Instance type for VPN nodes.",
      "Type" : "String",
      "Default" : "t2.micro",
      "AllowedValues" : [ "t2.micro","t2.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    },
    "WWWNodeInstanceType" : {
      "Description" : "Instance type for WWW nodes.",
      "Type" : "String",
      "Default" : "t2.micro",
      "AllowedValues" : [ "t2.micro","t2.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    },
    "AvailabilityZone" : {
      "Description" : "AZ to use for PublicSubnet/PrivateSubnet.",
      "Type" : "String",
      "Default" : "us-east-1c"
    }
  },

  "Mappings" : {
    "UBUNTUAMI" : {
      "us-east-1"      : { "AMI" : "ami-76e27e1e" },
      "us-west-2"      : { "AMI" : "ami-838dd9b3" },
      "us-west-1"      : { "AMI" : "ami-d5180890" },
      "eu-west-1"      : { "AMI" : "ami-863686f1" },
      "ap-southeast-1" : { "AMI" : "ami-f75875a5" },
      "ap-southeast-2" : { "AMI" : "ami-950b62af" },
      "ap-northeast-1" : { "AMI" : "ami-4ceaed4d" },
      "sa-east-1"      : { "AMI" : "ami-cb70c1d6" }
    }
  },

  "Resources" : {
    "MumbleNetworkInterface" : {
      "Type" : "AWS::EC2::NetworkInterface",
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet" },
        "PrivateIpAddress" : "10.0.1.10",
        "Description" : "NAT Interface",
        "GroupSet" : [ { "Ref" : "MumbleSecurityGroup" } ]
      }
    },

    "MumbleInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : ["S3Backup"]
      }
    },

    "MumbleInstance" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata" : {
        "Comment1" : "Create mumble server"
      },
      "Properties" : {
        "InstanceType" : { "Ref" : "MumbleNodeInstanceType" },
        "KeyName" : { "Ref" : "KeyName" },
        "IamInstanceProfile" : { "Ref" : "MumbleInstanceProfile" },
        "NetworkInterfaces" : [ { 
          "NetworkInterfaceId" : { "Ref" : "MumbleNetworkInterface"},
          "DeviceIndex" : "0"
        } ],
        "ImageId" : { "Fn::FindInMap" : [ "UBUNTUAMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [
          { "Key" : "Name", "Value" : "mumble" }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -v\n",
          "wget -O bootstrap-unpro.sh https://raw.githubusercontent.com/TronPaul/unpro-salt/master/bootstrap-unpro-salt\n",
          "sh ./bootstrap-unpro.sh -i mumble\n"
        ]]}}
      }
    },

    "MumbleSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Rules for allowing access to HA Nodes",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
           { "IpProtocol" : "tcp", "FromPort" : "22",  "ToPort" : "22",  "CidrIp" : { "Ref" : "VpcCidr" }} ,
           { "IpProtocol" : "-1", "FromPort" : "64738",  "ToPort" : "64738",  "CidrIp" : { "Ref" : "VpcCidr" }} ],
        "SecurityGroupEgress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" } ]
      }
    },

    "MumblePrivateDNSRecord" : {
      "Type" : "AWS::Route53::RecordSet",
      "DependsOn" : "MumbleInstance",
      "Properties" : {
        "HostedZoneName" : "teamunpro.",
        "Name" : "mumble.teamunpro.",
        "Type" : "CNAME",
        "TTL" : "60",
        "ResourceRecords" : [ {"Fn::GetAtt" : [ "MumbleInstance", "PrivateDnsName" ] } ]
      }
    },

    "VPNNetworkInterface" : {
      "Type" : "AWS::EC2::NetworkInterface",
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet" },
        "PrivateIpAddress" : "10.0.1.11",
        "Description" : "NAT Interface",
        "GroupSet" : [ { "Ref" : "VPNSecurityGroup" } ]
      }
    },

    "VPNInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : ["VPNCACert"]
      }
    },

    "VPNInstance" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata" : {
        "Comment1" : "Create openvpn server"
      },
      "Properties" : {
        "InstanceType" : { "Ref" : "VPNNodeInstanceType" },
        "KeyName" : { "Ref" : "KeyName" },
        "IamInstanceProfile" : { "Ref" : "VPNInstanceProfile" },
        "NetworkInterfaces" : [ { 
          "NetworkInterfaceId" : { "Ref" : "VPNNetworkInterface"},
          "DeviceIndex" : "0"
        } ],
        "ImageId" : { "Fn::FindInMap" : [ "UBUNTUAMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [
          { "Key" : "Name", "Value" : "vpn" }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -v\n",
          "wget -O bootstrap-unpro.sh https://raw.githubusercontent.com/TronPaul/unpro-salt/master/bootstrap-unpro-salt\n",
          "sh ./bootstrap-unpro.sh -i vpn\n"
        ]]}}
      }
    },

    "VPNSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Rules for allowing access to HA Nodes",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
           { "IpProtocol" : "tcp", "FromPort" : "22",  "ToPort" : "22",  "CidrIp" : { "Ref" : "VpcCidr" }},
           { "IpProtocol" : "udp", "FromPort" : "1194",  "ToPort" : "1194",  "CidrIp" : { "Ref" : "VpcCidr" }}],
        "SecurityGroupEgress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" } ]
      }
    },

    "VPNPrivateDNSRecord" : {
      "Type" : "AWS::Route53::RecordSet",
      "DependsOn" : "VPNInstance",
      "Properties" : {
        "HostedZoneName" : "teamunpro.",
        "Name" : "vpn.teamunpro.",
        "Type" : "CNAME",
        "TTL" : "60",
        "ResourceRecords" : [ {"Fn::GetAtt" : [ "VPNInstance", "PrivateDnsName" ] } ]
      }
    },

    "WWWNetworkInterface" : {
      "Type" : "AWS::EC2::NetworkInterface",
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet" },
        "PrivateIpAddress" : "10.0.1.12",
        "Description" : "NAT Interface",
        "GroupSet" : [ { "Ref" : "WWWSecurityGroup" } ]
      }
    },

    "WWWInstance" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata" : {
        "Comment1" : "Create www server"
      },
      "Properties" : {
        "InstanceType" : { "Ref" : "WWWNodeInstanceType" },
        "KeyName" : { "Ref" : "KeyName" },
        "NetworkInterfaces" : [ { 
          "NetworkInterfaceId" : { "Ref" : "WWWNetworkInterface"},
          "DeviceIndex" : "0"
        } ],
        "ImageId" : { "Fn::FindInMap" : [ "UBUNTUAMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [
          { "Key" : "Name", "Value" : "www" }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -v\n",
          "wget -O bootstrap-unpro.sh https://raw.githubusercontent.com/TronPaul/unpro-salt/master/bootstrap-unpro-salt\n",
          "sh ./bootstrap-unpro.sh -i www\n"
        ]]}}
      }
    },

    "WWWSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Rules for allowing access to HA Nodes",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
           { "IpProtocol" : "tcp", "FromPort" : "22",  "ToPort" : "22",  "CidrIp" : { "Ref" : "VpcCidr" }},
           { "IpProtocol" : "tcp", "FromPort" : "80",  "ToPort" : "80",  "CidrIp" : { "Ref" : "VpcCidr" }}, 
           { "IpProtocol" : "tcp", "FromPort" : "443",  "ToPort" : "443",  "CidrIp" : { "Ref" : "VpcCidr" }}],
        "SecurityGroupEgress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" } ]
      }
    },

    "WWWPrivateDNSRecord" : {
      "Type" : "AWS::Route53::RecordSet",
      "DependsOn" : "WWWInstance",
      "Properties" : {
        "HostedZoneName" : "teamunpro.",
        "Name" : "www.teamunpro.",
        "Type" : "CNAME",
        "TTL" : "60",
        "ResourceRecords" : [ {"Fn::GetAtt" : [ "WWWInstance", "PrivateDnsName" ] } ]
      }
    }
  }
}
